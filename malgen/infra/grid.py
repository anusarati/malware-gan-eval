from pathlib import Path
import matplotlib.pyplot as plt
from mpl_toolkits.axes_grid1 import ImageGrid
import argparse
from malgen.infra.constants import CATEGORIES
import itertools

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-i,", "--idir", type=str)
    args = parser.parse_args()
    idir = Path(args.idir)
    # expect a bunch of directories here
    paths = list(idir.iterdir())

    num_imgs_per_class = 10
    num_classes = 11
    fig = plt.figure(figsize=(4.0, 4.0))
    grid = ImageGrid(
        fig,
        111,  # similar to subplot(111)
        nrows_ncols=(num_classes, num_imgs_per_class),
        axes_pad=0.1,  # pad between Axes in inch.
        label_mode="all",
    )

    axiter = iter(grid)
    for i in range(num_classes):
        class_dir = idir / str(i)
        if not class_dir.is_dir():
            class_dir = idir / CATEGORIES[i]
        images = itertools.islice(
            filter(lambda p: p.suffix == ".png", class_dir.iterdir()),
            num_imgs_per_class,
        )
        for j in range(num_imgs_per_class):
            ax = next(axiter)
            ax.imshow(images[j])

    plt.savefig(f'{args.idir}-plot.png')
