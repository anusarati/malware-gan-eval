from pathlib import Path
import matplotlib.pyplot as plt
import argparse
from malgen.infra.constants import CATEGORIES
import itertools
from PIL import Image
import numpy as np

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-i,", "--idir", type=str)
    args = parser.parse_args()
    idir = Path(args.idir)
    # expect a bunch of directories here
    paths = list(idir.iterdir())

    num_imgs_per_class = 10
    num_classes = 11
    images = []

    for i in range(num_classes):
        class_dir = idir / str(i)
        if not class_dir.is_dir():
            class_dir = idir / CATEGORIES[i]
        class_images = list(
            itertools.islice(
                filter(lambda p: p.suffix == ".png", class_dir.iterdir()),
                num_imgs_per_class,
            )
        )
        images.append(class_images)

    plt.rcParams["savefig.bbox"] = "tight"
    fig, axs = plt.subplots(nrows=num_classes, ncols=num_imgs_per_class, squeeze=False)
    for i in range(num_classes):
        for j in range(num_imgs_per_class):
            image = Image.open(Image.open(images[i][j]))
            axs[i, j].imshow(
                np.asarray(image),
                cmap="gray" if image.mode == "L" else "viridis",
                vmin=0,
                vmax=255,
            )
            axs[i, j].set(
                xticklabels=[], yticklabels=[], xticks=[], yticks=[]
            )
        axs[i, 0].set_ylabel(CATEGORIES[i])
    
    fig.tight_layout(pad=0)

    plt.savefig(f"{args.idir}-plot.png")
