from pathlib import Path
from matplotlib import gridspec
import matplotlib.pyplot as plt
import argparse
from malgen.infra.constants import CATEGORIES
import itertools
from PIL import Image
import numpy as np

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-i,", "--idir", type=str)
    args = parser.parse_args()
    idir = Path(args.idir)
    # expect a bunch of directories here
    paths = list(idir.iterdir())

    num_imgs_per_class = 10
    num_classes = 11
    images = []

    for i in range(num_classes):
        class_dir = idir / str(i)
        if not class_dir.is_dir():
            class_dir = idir / CATEGORIES[i]
        class_images = list(
            itertools.islice(
                filter(lambda p: p.suffix == ".png", class_dir.iterdir()),
                num_imgs_per_class,
            )
        )
        images.append(class_images)

    # https://stackoverflow.com/a/41075262
    fig = plt.figure(figsize=(num_imgs_per_class + 1, num_classes + 1))
    gs = gridspec.GridSpec(
        nrows=num_classes,
        ncols=num_imgs_per_class,
        wspace=0.0,
        hspace=0.0,
        top=1.0 - 0.5 / (num_classes + 1),
        bottom=0.5 / (num_classes + 1),
        left=0.5 / (num_imgs_per_class + 1),
        right=1 - 0.5 / (num_imgs_per_class + 1),
    )

    for i in range(num_classes):
        plt.subplot(gs[i, 0]).set_ylabel(
            CATEGORIES[i], size="large"
        )
        for j in range(num_imgs_per_class):
            image = Image.open(images[i][j])
            ax = plt.subplot(gs[i, j])
            ax.imshow(
                np.asarray(image),
                cmap="gray" if image.mode == "L" else "viridis",
                vmin=0,
                vmax=255,
            )
            ax.set(xticklabels=[], yticklabels=[], xticks=[], yticks=[])

    plt.subplots_adjust(left=0.01, wspace=0, hspace=0)

    plt.savefig(f"{args.idir}-plot.png", dpi=600)
