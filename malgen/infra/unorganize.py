"Make a hierarchical directory of images into a flattened folder with hardlinks to the images"

import argparse
from pathlib import Path
from PIL import Image
import os
from tqdm.contrib.concurrent import thread_map

Image.MAX_IMAGE_PIXELS = int(1e9)


def unorganize(idir, outdir):

    idir = Path(idir)
    outdir = Path(outdir)
    for dirpath, _, filenames in os.walk(idir):
        dirpath = Path(dirpath)

        def link(filename):
            path = dirpath / filename
            if path.suffix == ".png":
                os.link(path, outdir / filename)

        thread_map(link, filenames)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-i", "--dir", type=str, required=True)
    parser.add_argument("-o", "--out", type=str, required=True)
    args = parser.parse_args()
    print(args, flush=True)
    unorganize(
        idir=args.dir,
        outdir=args.out if args.out else ".",
    )
