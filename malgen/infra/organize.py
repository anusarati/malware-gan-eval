"""
Create a hierarchical directory of images linked to an unorganized but labeled image directory
and create dataset.json file for StyleGAN
"""

import argparse
from pathlib import Path
import os
from tqdm.contrib.concurrent import thread_map
import pickle
from malgen.infra.constants import CATEGORIES
from threading import Lock
import json


def organize(idir, outdir):

    idir = Path(idir)
    outdir = Path(outdir)
    with open(idir / "labels.pkl", "rb") as f:
        labels = pickle.load(f)
    for category in CATEGORIES:
        (outdir / category).mkdir(parents=True, exist_ok=True)

    slabels = []
    label_lock = Lock()

    for dirpath, _, filenames in os.walk(idir):
        dirpath = Path(dirpath)

        def _organize(filename):
            path: Path = dirpath / filename
            if path.suffix == ".png":
                categories = labels[filename]
                for category_idx in enumerate(categories):
                    category = CATEGORIES[category_idx]
                    relpath = Path(category) / filename
                    outpath = outdir / relpath
                    os.link(path, outpath)
                    with label_lock:
                        slabels.append([str(relpath), category_idx])

        thread_map(_organize, filenames)

    with open("dataset.json", "w") as f:
        json.dump({"labels": slabels}, f)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-i", "--dir", type=str, required=True)
    parser.add_argument("-o", "--out", type=str, required=True)
    args = parser.parse_args()
    print(args, flush=True)
    organize(idir=args.dir, outdir=args.out)
