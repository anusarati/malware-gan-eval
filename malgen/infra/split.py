"""Splits a directory into a training and testing set"""

import argparse
import os
from pathlib import Path
import pickle
import pyarrow.parquet as pq
import shutil
from tqdm.contrib.concurrent import thread_map


def split(idir, base_out):
    idir = Path(idir)
    relpath = Path(*idir.parts[1:])
    base_out = Path(base_out)
    (base_out / relpath).mkdir(parents=True, exist_ok=True)

    test = pq.read_table("test.parquet").to_pandas()
    test_hashes = set(test["hash"].values)

    shutil.copy("train.parquet", idir / "meta.parquet")
    shutil.copy("test.parquet", base_out / relpath / "meta.parquet")
    # bucket after
    for dirpath, _, filenames in os.walk(idir):
        relpath = Path(*Path(dirpath).parts[1:])
        odir = base_out / relpath
        odir.mkdir(parents=True, exist_ok=True)

        def check_move(filename):
            if Path(filename).stem in test_hashes:
                inpath = Path(dirpath, filename)
                shutil.move(inpath, odir / filename)

        thread_map(check_move, filenames)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-i", "--idir", type=str)
    parser.add_argument("-o", "--odir", type=str)
    args = parser.parse_args()
    split(idir=args.idir, base_out=args.odir)
