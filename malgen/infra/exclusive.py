"""Filters out all images that are in multiple malware families"""

from collections import namedtuple
import sqlite3
from malgen.infra.constants import CATEGORIES, COLUMNS, OTHER_METADATA
import pyarrow as pa


if __name__ == "__main__":
    con = sqlite3.connect("meta.db")

    hashes = []
    labels = []

    Row = namedtuple("Row", COLUMNS)
    con.row_factory = lambda _, data: Row(*data)
    cur = con.cursor()
    res = cur.execute(f"SELECT * FROM meta WHERE is_malware >= 1;")
    while row := res.fetchone():
        if row.is_malware:
            categories = row[len(OTHER_METADATA) :]
            if sum(categories) == 1:
                hashes.append(row.sha256)
                labels.append(categories.index(1))

    table = pa.Table.from_arrays([hashes, labels], names=["hashes", "labels"])
    pa.write_table(table, "exclusive.parquet")
    con.close()
