"""Train with progressive growing for StyleSAN-XL"""

import argparse
import os
from pathlib import Path
import subprocess
import sys

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-if", "--idirf", type=str, required=True)
    parser.add_argument("-s", "--stop_size", type=int, required=True)
    parser.add_argument("-g", "--gpus", type=int, required=True)
    parser.add_argument("-b", "--batch_size", type=int, default=64)
    parser.add_argument("-r", "--resume", type=int)

    args = parser.parse_args()
    print(args)

    img_sizes = [args.resume] if args.resume else [16]

    while img_sizes[-1] != args.stop_size:
        img_sizes.append(img_sizes[-1] * 2)

    base_outdir = Path("./training-runs/progressive")

    base_command = "python train.py --cfg=stylegan3-t --mirror=False --snap 10 --cbase 16384 --cmax 256 --syn_layers 7 --cond True "
    base_args = "--outdir={outdir} --gpus={gpus} --batch {batch} --kimg {kimg} --data {data_path} "

    superres_args = "--superres --up_factor 2 --head_layers 7 --path_stem {path_stem} "

    for i in range(len(img_sizes)):
        img_size = img_sizes[i]
        kimg = 10000 if img_size < 128 else 5000
        data_path = args.idirf.format(img_size)
        outdir = base_outdir / str(img_size)

        command = base_command + base_args.format(
            outdir=str(outdir),
            gpus=args.gpus,
            batch=args.batch_size,
            kimg=kimg,
            data_path=data_path,
        )

        if img_size != 16:
            prev_dir = base_outdir / str(img_size // 2)
            # find the most recent network-snapshot.pkl file from the previous training directory
            latest_dir = max(
                filter(lambda path: path.is_dir(), Path(prev_dir).iterdir()),
                key=os.path.getmtime,
            )
            print("Using stem from", str(latest_dir))

            command += superres_args.format(
                path_stem=str(latest_dir / "network-snapshot.pkl")
            )

        if i == 0 and args.resume:
            resume_path = base_outdir / str(args.resume) / "network-snapshot.pkl"
            command += f"--resume {resume_path}"

        print(command)
        subprocess.run(
            command.split(), stdout=sys.stdout, stderr=sys.stderr, check=True
        )
