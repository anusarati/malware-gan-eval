from pathlib import Path
from tqdm import tqdm
from tqdm.contrib.concurrent import thread_map
import os
import argparse
from pyarrow import parquet as pq

parser = argparse.ArgumentParser()
parser.add_argument("-o", "--odir", type=str)
parser.add_argument("-e", "--ext", type=str, default=".png")
args = parser.parse_args()

idir = Path(args.idir)
outdir = Path(args.odir)

meta = pq.read_table(args.idir / "meta.parquet").to_pandas()
paths = [idir / (h + ".txt") for h in meta["hash"]]
outpaths = thread_map(lambda p: outdir / (p.name + args.ext), paths)
missing = thread_map(lambda p: not os.path.isfile(p), outpaths)

print(missing.count(1))

with open("rem.txt", "w") as f:
    for i, path in tqdm(enumerate(paths)):
        if missing[i]:
            print(str(path), file=f)
