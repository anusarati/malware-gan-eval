from pathlib import Path
from tqdm import tqdm
from tqdm.contrib.concurrent import thread_map
import os
import argparse
from pyarrow import parquet as pq

parser = argparse.ArgumentParser()
parser.add_argument("-i", "--idir", type=str)
parser.add_argument("-o", "--odir", type=str)
parser.add_argument("-e", "--ext", type=str, default=".png")
args = parser.parse_args()

idir = Path(args.idir)
outdir = Path(args.odir)

meta = pq.read_table(idir / "meta.parquet").to_pandas()
outs = set(
    fname
    for _, _, fnames in os.walk(args.odir)
    for fname in fnames
    if Path(fname).suffix == args.ext
)
missing_paths = [idir / (h + ".txt") for h in meta["hash"].values if h not in outs]

print(len(missing_paths))

with open("rem.txt", "w") as f:
    for path in tqdm(missing_paths):
        print(str(path), file=f)
