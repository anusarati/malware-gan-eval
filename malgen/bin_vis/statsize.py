"""Get statistics about square binary image side lengths"""

from pathlib import Path
import argparse
from math import ceil
from tqdm.contrib.concurrent import thread_map
from threading import Lock
import os
import pickle
from PIL import Image


def stat_sizes(rank, world_size, idir, out):
    out = Path(out)
    idir = Path(idir)
    paths = list(
        Path(dirpath, filename)
        for dirpath, _, filenames in os.walk(idir)
        for filename in filenames
    )
    n_per_node = ceil(len(paths) / world_size)

    assigned = paths[n_per_node * rank : n_per_node * (rank + 1)]
    size_freqs = {}
    freqs_lock = Lock()

    def update_size(path):
        if path.suffix in {".png", ".pt"}:
            size = Image.open(path).size[0]
            with freqs_lock:
                size_freqs.setdefault(size, 0)
                size_freqs[size] += 1

    thread_map(update_size, assigned)
    with open(out / f"_sizefreqs{rank}.pkl", "wb") as f:
        pickle.dump(size_freqs, f)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-rank", type=int)
    parser.add_argument("-world_size", type=int)
    parser.add_argument("-dir", type=str)
    parser.add_argument("-out", type=str)
    args = parser.parse_args()
    print(args)
    stat_sizes(
        rank=args.rank,
        world_size=args.world_size,
        idir=args.dir,
        out=args.out if args.out else ".",
    )
