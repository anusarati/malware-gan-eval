from PIL import Image
from math import sqrt
from pathlib import Path


def visualize(filepath, mode="L"):
    """
    Returns a square image of the file at filepath
    """
    with open(filepath, "rb", 0) as bytestream:
        bin = bytestream.readall()
        size = len(bin)

        side = sqrt(size)
        if mode == "RGB":
            side //= 3
        side = int(side)

        if mode in ("L", "RGB"):
            return Image.frombytes(mode, (side, side), bin)


def save_size_vars(img, dir, filename):
    dir = Path(dir)
    (dir / "128").mkdir(parents=True, exist_ok=True)
    (dir / "512").mkdir(parents=True, exist_ok=True)
    img.save(dir / filename)
    img.resize((128, 128), Image.NEAREST).save(dir / "128" / filename)
    img.resize((512, 512), Image.NEAREST).save(dir / "512" / filename)


def save_vars(path, dir=""):
    path = Path(path)
    dir = Path(dir)
    filename = path.name + ".png"

    img = visualize(path)
    save_size_vars(img, dir / "gray", filename)
    img = visualize(path, mode="RGB")
    save_size_vars(img, dir / "rgb", filename)


import pandas as pd
from infra.constants import CATEGORIES


def visualize_examples():
    df = pd.read_pickle("corrected.pkl")
    for category in CATEGORIES:
        within_category = df.query(f"{category} >= 1").sample(10)
        for hash in within_category["sha256"]:
            save_vars(f"bins/decompressed/{hash}", f"imgs/{category}")


import torch
from embedding import embed
from embedding.color import RGBProjector
from tqdm.contrib.concurrent import thread_map


@torch.inference_mode()
def visualize_embeds():
    projector = torch.load("rgbproj.pkl")
    if torch.cuda.is_available():
        projector = projector.to("cuda")

    df = pd.read_pickle("corrected.pkl")
    for category in CATEGORIES:
        within_category = df.query(f"{category} >= 1").sample(10, random_state=42)

        def _visualize_embeds(hash):
            path = f"statout/txt/{hash}"
            emb = embed.embed(path)
            if torch.cuda.is_available():
                emb = emb.to("cuda")

            img = projector.pil(emb)
            save_size_vars(img, f"imgs/{category}/embed/rgb", f"{hash}.png")

        thread_map(_visualize_embeds, within_category["sha256"])


if __name__ == "__main__":
    visualize_embeds()
