"""Resize a directory of images"""

from pathlib import Path
import argparse
from math import ceil
from tqdm.contrib.concurrent import thread_map
import os
import shutil
from PIL import Image

Image.MAX_IMAGE_PIXELS = 1e38


def resize(idir, obase, sizes, rank, world_size):
    idir = Path(idir)
    obase = Path(obase)

    paths = []
    for dir, _, fnames in os.walk(idir):
        reldir = Path(os.path.relpath(dir, idir))
        for size in sizes:
            (obase / str(size) / reldir).mkdir(parents=True, exist_ok=True)
        for fname in fnames:
            paths.append(reldir / fname)

    n_per_node = ceil(len(paths) / world_size)
    assigned_paths = paths[n_per_node * rank : n_per_node * (rank + 1)]

    for size in sizes:
        odir = obase / str(size)

        def _resize(path):
            ipath = idir / path
            opath = odir / path
            if ipath.suffix == ".png":
                image = Image.open(ipath)
                image = image.resize((size, size))
                image.save(opath)
            else:
                shutil.copy(ipath, opath)

        thread_map(_resize, assigned_paths)


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument("-rank", type=int)
    parser.add_argument("-i", "--idir", type=str, required=True)
    parser.add_argument("-o", "--obase", type=str, required=True)
    parser.add_argument("-s", "--sizes", required=True, type=int, nargs="+")
    parser.add_argument("-world_size", type=int)
    args = parser.parse_args()
    print(args, flush=True)
    resize(
        idir=args.idir,
        obase=args.obase,
        sizes=args.sizes,
        rank=args.rank,
        world_size=args.world_size,
    )
